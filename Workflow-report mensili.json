{
â€œnameâ€: â€œCER Magliano - Generazione Report Mensiliâ€,
â€œnodesâ€: [
{
â€œparametersâ€: {
â€œruleâ€: {
â€œintervalâ€: [
{
â€œfieldâ€: â€œdayOfMonthâ€,
â€œdayOfMonthâ€: 1
},
{
â€œfieldâ€: â€œhourâ€,
â€œhourâ€: 6
}
]
}
},
â€œnameâ€: â€œTrigger Primo del Meseâ€,
â€œtypeâ€: â€œn8n-nodes-base.scheduleTriggerâ€,
â€œpositionâ€: [250, 300],
â€œidâ€: â€œtrigger-mensileâ€
},
{
â€œparametersâ€: {
â€œjsCodeâ€: â€œconst now = new Date();\nconst primoGiornoMeseScorso = new Date(now.getFullYear(), now.getMonth() - 1, 1);\nconst ultimoGiornoMeseScorso = new Date(now.getFullYear(), now.getMonth(), 0);\n\nreturn [{\n  json: {\n    anno: primoGiornoMeseScorso.getFullYear(),\n    mese: primoGiornoMeseScorso.getMonth() + 1,\n    data_inizio: primoGiornoMeseScorso.toISOString(),\n    data_fine: ultimoGiornoMeseScorso.toISOString(),\n    nome_mese: primoGiornoMeseScorso.toLocaleDateString(â€˜it-ITâ€™, { month: â€˜longâ€™ }),\n    periodo: `${primoGiornoMeseScorso.toLocaleDateString('it-IT')} - ${ultimoGiornoMeseScorso.toLocaleDateString('it-IT')}`\n  }\n}];â€
},
â€œnameâ€: â€œCalcola Periodo Mese Scorsoâ€,
â€œtypeâ€: â€œn8n-nodes-base.codeâ€,
â€œpositionâ€: [450, 300],
â€œidâ€: â€œcalc-periodoâ€
},
{
â€œparametersâ€: {
â€œoperationâ€: â€œexecuteQueryâ€,
â€œqueryâ€: â€œSELECT \n  m.id as membro_id,\n  m.codice_membro,\n  m.nome,\n  m.cognome,\n  m.tipo_membro,\n  m.email,\n  COALESCE(SUM(p.energia_prodotta_kwh), 0) as energia_prodotta_kwh,\n  COALESCE(SUM(c.energia_consumata_kwh), 0) as energia_consumata_kwh,\n  COALESCE(SUM(r.energia_condivisa_membro_kwh), 0) as energia_condivisa_kwh,\n  COALESCE(SUM(r.incentivo_spettante_euro), 0) as incentivo_totale_euro,\n  COUNT(DISTINCT DATE(r.timestamp)) as giorni_attivi\nFROM membri m\nLEFT JOIN impianti i ON m.id = i.membro_id AND i.attivo = true\nLEFT JOIN produzione_oraria p ON i.id = p.impianto_id \n  AND p.timestamp >= â€˜{{ $json.data_inizio }}â€™ \n  AND p.timestamp < â€˜{{ $json.data_fine }}â€™\nLEFT JOIN consumo_orario c ON m.id = c.membro_id \n  AND c.timestamp >= â€˜{{ $json.data_inizio }}â€™ \n  AND c.timestamp < â€˜{{ $json.data_fine }}â€™\nLEFT JOIN ripartizione_oraria r ON m.id = r.membro_id \n  AND r.timestamp >= â€˜{{ $json.data_inizio }}â€™ \n  AND r.timestamp < â€˜{{ $json.data_fine }}â€™\nWHERE m.attivo = true\nGROUP BY m.id, m.codice_membro, m.nome, m.cognome, m.tipo_membro, m.email\nORDER BY energia_condivisa_kwh DESCâ€
},
â€œnameâ€: â€œCalcola Dati Mensili per Membroâ€,
â€œtypeâ€: â€œn8n-nodes-base.postgresâ€,
â€œpositionâ€: [650, 300],
â€œcredentialsâ€: {
â€œpostgresâ€: {
â€œidâ€: â€œ1â€,
â€œnameâ€: â€œPostgreSQL CERâ€
}
},
â€œidâ€: â€œcalc-dati-mensiliâ€
},
{
â€œparametersâ€: {
â€œjsCodeâ€: â€œconst items = $input.all();\nconst periodo = items[0].json;\n\nconst membri = items.slice(1).map(item => {\n  const data = item.json;\n  const autoconsumo = data.energia_consumata_kwh > 0 \n    ? ((data.energia_condivisa_kwh / data.energia_consumata_kwh) * 100).toFixed(2)\n    : 0;\n  \n  // Stima risparmio bolletta (energia condivisa a prezzo PUN medio ~0.15 â‚¬/kWh)\n  const risparmio_bolletta = (data.energia_condivisa_kwh * 0.15).toFixed(2);\n  \n  // CO2 risparmiata (0.3 kg CO2 per kWh)\n  const co2_risparmiata = (data.energia_prodotta_kwh * 0.3).toFixed(2);\n  \n  return {\n    â€¦data,\n    percentuale_autoconsumo: autoconsumo,\n    risparmio_bolletta_stimato_euro: risparmio_bolletta,\n    co2_risparmiata_kg: co2_risparmiata,\n    anno: periodo.anno,\n    mese: periodo.mese,\n    periodo: periodo.periodo,\n    nome_mese: periodo.nome_mese\n  };\n});\n\nreturn membri.map(m => ({ json: m }));â€
},
â€œnameâ€: â€œCalcola Metriche Aggiuntiveâ€,
â€œtypeâ€: â€œn8n-nodes-base.codeâ€,
â€œpositionâ€: [850, 300],
â€œidâ€: â€œcalc-metricheâ€
},
{
â€œparametersâ€: {
â€œoperationâ€: â€œexecuteQueryâ€,
â€œqueryâ€: â€œINSERT INTO report_mensili (\n  anno,\n  mese,\n  membro_id,\n  energia_prodotta_kwh,\n  energia_consumata_kwh,\n  energia_condivisa_kwh,\n  percentuale_autoconsumo,\n  incentivo_totale_euro,\n  risparmio_bolletta_stimato_euro,\n  co2_risparmiata_kg,\n  stato_pagamento\n) VALUES (\n  {{ $json.anno }},\n  {{ $json.mese }},\n  â€˜{{ $json.membro_id }}â€™,\n  {{ $json.energia_prodotta_kwh }},\n  {{ $json.energia_consumata_kwh }},\n  {{ $json.energia_condivisa_kwh }},\n  {{ $json.percentuale_autoconsumo }},\n  {{ $json.incentivo_totale_euro }},\n  {{ $json.risparmio_bolletta_stimato_euro }},\n  {{ $json.co2_risparmiata_kg }},\n  â€˜da_pagareâ€™\n) ON CONFLICT (anno, mese, membro_id) DO UPDATE SET\n  energia_prodotta_kwh = EXCLUDED.energia_prodotta_kwh,\n  energia_consumata_kwh = EXCLUDED.energia_consumata_kwh,\n  energia_condivisa_kwh = EXCLUDED.energia_condivisa_kwh,\n  percentuale_autoconsumo = EXCLUDED.percentuale_autoconsumo,\n  incentivo_totale_euro = EXCLUDED.incentivo_totale_euro,\n  risparmio_bolletta_stimato_euro = EXCLUDED.risparmio_bolletta_stimato_euro,\n  co2_risparmiata_kg = EXCLUDED.co2_risparmiata_kgâ€
},
â€œnameâ€: â€œSalva Report su DBâ€,
â€œtypeâ€: â€œn8n-nodes-base.postgresâ€,
â€œpositionâ€: [1050, 300],
â€œcredentialsâ€: {
â€œpostgresâ€: {
â€œidâ€: â€œ1â€,
â€œnameâ€: â€œPostgreSQL CERâ€
}
},
â€œidâ€: â€œsave-reportâ€
},
{
â€œparametersâ€: {
â€œoperationâ€: â€œcreateâ€,
â€œdocumentIdâ€: â€œ{{ $json.spreadsheet_id }}â€,
â€œsheetNameâ€: â€œReport {{ $json.nome_mese }} {{ $json.anno }}â€,
â€œoptionsâ€: {
â€œinsertDataOptionâ€: â€œINSERT_ROWSâ€
},
â€œcolumnsâ€: {
â€œmappingsâ€: [
{
â€œcolumnâ€: â€œCodice Membroâ€,
â€œvalueâ€: â€œ={{ $json.codice_membro }}â€
},
{
â€œcolumnâ€: â€œNomeâ€,
â€œvalueâ€: â€œ={{ $json.nome }}â€
},
{
â€œcolumnâ€: â€œTipoâ€,
â€œvalueâ€: â€œ={{ $json.tipo_membro }}â€
},
{
â€œcolumnâ€: â€œProduzione kWhâ€,
â€œvalueâ€: â€œ={{ $json.energia_prodotta_kwh }}â€
},
{
â€œcolumnâ€: â€œConsumo kWhâ€,
â€œvalueâ€: â€œ={{ $json.energia_consumata_kwh }}â€
},
{
â€œcolumnâ€: â€œEnergia Condivisa kWhâ€,
â€œvalueâ€: â€œ={{ $json.energia_condivisa_kwh }}â€
},
{
â€œcolumnâ€: â€œAutoconsumo %â€,
â€œvalueâ€: â€œ={{ $json.percentuale_autoconsumo }}â€
},
{
â€œcolumnâ€: â€œIncentivi â‚¬â€,
â€œvalueâ€: â€œ={{ $json.incentivo_totale_euro }}â€
},
{
â€œcolumnâ€: â€œRisparmio Stimato â‚¬â€,
â€œvalueâ€: â€œ={{ $json.risparmio_bolletta_stimato_euro }}â€
},
{
â€œcolumnâ€: â€œCO2 Risparmiata kgâ€,
â€œvalueâ€: â€œ={{ $json.co2_risparmiata_kg }}â€
}
]
}
},
â€œnameâ€: â€œAggiorna Google Sheetâ€,
â€œtypeâ€: â€œn8n-nodes-base.googleSheetsâ€,
â€œpositionâ€: [1250, 300],
â€œcredentialsâ€: {
â€œgoogleSheetsOAuth2Apiâ€: {
â€œidâ€: â€œ5â€,
â€œnameâ€: â€œGoogle Sheets CERâ€
}
},
â€œidâ€: â€œupdate-sheetâ€
},
{
â€œparametersâ€: {
â€œoperationâ€: â€œgenerateDocumentâ€,
â€œtemplateIdâ€: â€œ{{ $json.template_pdf_id }}â€,
â€œoptionsâ€: {
â€œmappingsâ€: [
{
â€œfieldâ€: â€œnome_membroâ€,
â€œvalueâ€: â€œ={{ $json.nome }} {{ $json.cognome }}â€
},
{
â€œfieldâ€: â€œperiodoâ€,
â€œvalueâ€: â€œ={{ $json.periodo }}â€
},
{
â€œfieldâ€: â€œenergia_prodottaâ€,
â€œvalueâ€: â€œ={{ $json.energia_prodotta_kwh }}â€
},
{
â€œfieldâ€: â€œenergia_consumataâ€,
â€œvalueâ€: â€œ={{ $json.energia_consumata_kwh }}â€
},
{
â€œfieldâ€: â€œenergia_condivisaâ€,
â€œvalueâ€: â€œ={{ $json.energia_condivisa_kwh }}â€
},
{
â€œfieldâ€: â€œincentivo_totaleâ€,
â€œvalueâ€: â€œ={{ $json.incentivo_totale_euro }}â€
},
{
â€œfieldâ€: â€œrisparmio_stimatoâ€,
â€œvalueâ€: â€œ={{ $json.risparmio_bolletta_stimato_euro }}â€
},
{
â€œfieldâ€: â€œco2_risparmiataâ€,
â€œvalueâ€: â€œ={{ $json.co2_risparmiata_kg }}â€
}
]
}
},
â€œnameâ€: â€œGenera PDF Reportâ€,
â€œtypeâ€: â€œn8n-nodes-base.googleDocsâ€,
â€œpositionâ€: [1450, 300],
â€œcredentialsâ€: {
â€œgoogleDocsOAuth2Apiâ€: {
â€œidâ€: â€œ6â€,
â€œnameâ€: â€œGoogle Docs CERâ€
}
},
â€œidâ€: â€œgen-pdfâ€
},
{
â€œparametersâ€: {
â€œfromEmailâ€: â€œenergia@comune.magliano.gr.itâ€,
â€œtoEmailâ€: â€œ={{ $json.email }}â€,
â€œsubjectâ€: â€œReport Mensile CER Magliano - {{ $json.nome_mese }} {{ $json.anno }}â€,
â€œemailTypeâ€: â€œhtmlâ€,
â€œmessageâ€: â€œ<!DOCTYPE html>\n<html>\n<head>\n<style>\n  body { font-family: Arial, sans-serif; }\n  .header { background-color: #4CAF50; color: white; padding: 20px; text-align: center; }\n  .content { padding: 20px; }\n  .metric { background-color: #f1f1f1; padding: 15px; margin: 10px 0; border-radius: 5px; }\n  .metric-value { font-size: 24px; font-weight: bold; color: #4CAF50; }\n  .footer { background-color: #333; color: white; padding: 10px; text-align: center; font-size: 12px; }\n</style>\n</head>\n<body>\n  <div class='header'>\n    <h1>ComunitÃ  Energetica Rinnovabile</h1>\n    <h2>Comune di Magliano in Toscana</h2>\n  </div>\n  \n  <div class='content'>\n    <h2>Gentile {{ $json.nome }} {{ $json.cognome }},</h2>\n    <p>Ecco il riepilogo della tua partecipazione alla CER per il mese di <strong>{{ $json.nome_mese }} {{ $json.anno }}</strong>.</p>\n    \n    <div class='metric'>\n      <strong>âš¡ Energia Prodotta</strong><br>\n      <span class='metric-value'>{{ $json.energia_prodotta_kwh }} kWh</span>\n    </div>\n    \n    <div class='metric'>\n      <strong>ğŸ”Œ Energia Consumata</strong><br>\n      <span class='metric-value'>{{ $json.energia_consumata_kwh }} kWh</span>\n    </div>\n    \n    <div class='metric'>\n      <strong>ğŸ”„ Energia Condivisa nella CER</strong><br>\n      <span class='metric-value'>{{ $json.energia_condivisa_kwh }} kWh</span>\n    </div>\n    \n    <div class='metric'>\n      <strong>ğŸ’° Incentivi Maturati</strong><br>\n      <span class='metric-value'>â‚¬ {{ $json.incentivo_totale_euro }}</span>\n    </div>\n    \n    <div class='metric'>\n      <strong>ğŸ’µ Risparmio Stimato in Bolletta</strong><br>\n      <span class='metric-value'>â‚¬ {{ $json.risparmio_bolletta_stimato_euro }}</span>\n    </div>\n    \n    <div class='metric'>\n      <strong>ğŸŒ± CO2 Risparmiata</strong><br>\n      <span class='metric-value'>{{ $json.co2_risparmiata_kg }} kg</span>\n    </div>\n    \n    <p>In allegato trovi il report dettagliato in formato PDF.</p>\n    <p>Per qualsiasi domanda, contatta lâ€™ufficio energia del Comune.</p>\n  </div>\n  \n  <div class='footer'>\n    <p>Comune di Magliano in Toscana - ComunitÃ  Energetica Rinnovabile</p>\n    <p>Email: energia@comune.magliano.gr.it | Tel: 0564 123456</p>\n  </div>\n</body>\n</html>â€,
â€œoptionsâ€: {
â€œattachmentsâ€: â€œpdf_path={{ $json.pdf_path }}â€
}
},
â€œnameâ€: â€œInvia Email Reportâ€,
â€œtypeâ€: â€œn8n-nodes-base.emailSendâ€,
â€œpositionâ€: [1650, 300],
â€œcredentialsâ€: {
â€œsmtpâ€: {
â€œidâ€: â€œ7â€,
â€œnameâ€: â€œSMTP Comuneâ€
}
},
â€œidâ€: â€œsend-emailâ€
},
{
â€œparametersâ€: {
â€œoperationâ€: â€œexecuteQueryâ€,
â€œqueryâ€: â€œSELECT \n  SUM(energia_prodotta_kwh) as totale_produzione,\n  SUM(energia_consumata_kwh) as totale_consumo,\n  SUM(energia_condivisa_kwh) as totale_condivisa,\n  SUM(incentivo_totale_euro) as totale_incentivi,\n  SUM(risparmio_bolletta_stimato_euro) as totale_risparmi,\n  SUM(co2_risparmiata_kg) as totale_co2,\n  AVG(percentuale_autoconsumo) as autoconsumo_medio,\n  COUNT(*) as numero_membri\nFROM report_mensili\nWHERE anno = {{ $json.anno }} AND mese = {{ $json.mese }}â€
},
â€œnameâ€: â€œCalcola Totali CERâ€,
â€œtypeâ€: â€œn8n-nodes-base.postgresâ€,
â€œpositionâ€: [1050, 500],
â€œcredentialsâ€: {
â€œpostgresâ€: {
â€œidâ€: â€œ1â€,
â€œnameâ€: â€œPostgreSQL CERâ€
}
},
â€œidâ€: â€œcalc-totaliâ€
},
{
â€œparametersâ€: {
â€œchatIdâ€: â€œ{{ $json.telegram_gruppo_cer }}â€,
â€œtextâ€: â€œğŸ“Š *Report Mensile CER Magliano - {{ $json.nome_mese }} {{ $json.anno }}*\n\nâœ… Report generati per {{ $json.numero_membri }} membri\n\n*Totali ComunitÃ :*\nğŸ”† Produzione: {{ $json.totale_produzione }} kWh\nâš¡ Consumo: {{ $json.totale_consumo }} kWh\nğŸ”„ Energia Condivisa: {{ $json.totale_condivisa }} kWh\nğŸ“Š Autoconsumo Medio: {{ $json.autoconsumo_medio }}%\n\n*Benefici Economici:*\nğŸ’° Incentivi Totali: â‚¬{{ $json.totale_incentivi }}\nğŸ’µ Risparmi Stimati: â‚¬{{ $json.totale_risparmi }}\n\n*Impatto Ambientale:*\nğŸŒ± CO2 Risparmiata: {{ $json.totale_co2 }} kg\n\nTutti i membri hanno ricevuto il proprio report via email.â€,
â€œadditionalFieldsâ€: {
â€œparse_modeâ€: â€œMarkdownâ€
}
},
â€œnameâ€: â€œNotifica Report Completatoâ€,
â€œtypeâ€: â€œn8n-nodes-base.telegramâ€,
â€œpositionâ€: [1250, 500],
â€œcredentialsâ€: {
â€œtelegramApiâ€: {
â€œidâ€: â€œ3â€,
â€œnameâ€: â€œTelegram Bot CERâ€
}
},
â€œidâ€: â€œnotify-completatoâ€
},
{
â€œparametersâ€: {
â€œoperationâ€: â€œexecuteQueryâ€,
â€œqueryâ€: â€œINSERT INTO log_eventi (tipo_evento, descrizione, dati_json, severita) VALUES (\n  â€˜report_mensile_generatoâ€™,\n  â€˜Generati report mensili per {{ $json.numero_membri }} membriâ€™,\n  â€˜{"anno": {{ $json.anno }}, "mese": {{ $json.mese }}, "totale_incentivi": {{ $json.totale_incentivi }}}â€™,\n  â€˜infoâ€™\n)â€
},
â€œnameâ€: â€œLog Eventoâ€,
â€œtypeâ€: â€œn8n-nodes-base.postgresâ€,
â€œpositionâ€: [1450, 500],
â€œcredentialsâ€: {
â€œpostgresâ€: {
â€œidâ€: â€œ1â€,
â€œnameâ€: â€œPostgreSQL CERâ€
}
},
â€œidâ€: â€œlog-eventoâ€
}
],
â€œconnectionsâ€: {
â€œTrigger Primo del Meseâ€: {
â€œmainâ€: [
[
{
â€œnodeâ€: â€œCalcola Periodo Mese Scorsoâ€,
â€œtypeâ€: â€œmainâ€,
â€œindexâ€: 0
}
]
]
},
â€œCalcola Periodo Mese Scorsoâ€: {
â€œmainâ€: [
[
{
â€œnodeâ€: â€œCalcola Dati Mensili per Membroâ€,
â€œtypeâ€: â€œmainâ€,
â€œindexâ€: 0
}
]
]
},
â€œCalcola Dati Mensili per Membroâ€: {
â€œmainâ€: [
[
{
â€œnodeâ€: â€œCalcola Metriche Aggiuntiveâ€,
â€œtypeâ€: â€œmainâ€,
â€œindexâ€: 0
}
]
]
},
â€œCalcola Metriche Aggiuntiveâ€: {
â€œmainâ€: [
[
{
â€œnodeâ€: â€œSalva Report su DBâ€,
â€œtypeâ€: â€œmainâ€,
â€œindexâ€: 0
}
]
]
},
â€œSalva Report su DBâ€: {
â€œmainâ€: [
[
{
â€œnodeâ€: â€œAggiorna Google Sheetâ€,
â€œtypeâ€: â€œmainâ€,
â€œindexâ€: 0
},
{
â€œnodeâ€: â€œCalcola Totali CERâ€,
â€œtypeâ€: â€œmainâ€,
â€œindexâ€: 0
}
]
]
},
â€œAggiorna Google Sheetâ€: {
â€œmainâ€: [
[
{
â€œnodeâ€: â€œGenera PDF Reportâ€,
â€œtypeâ€: â€œmainâ€,
â€œindexâ€: 0
}
]
]
},
â€œGenera PDF Reportâ€: {
â€œmainâ€: [
[
{
â€œnodeâ€: â€œInvia Email Reportâ€,
â€œtypeâ€: â€œmainâ€,
â€œindexâ€: 0
}
]
]
},
â€œCalcola Totali CERâ€: {
â€œmainâ€: [
[
{
â€œnodeâ€: â€œNotifica Report Completatoâ€,
â€œtypeâ€: â€œmainâ€,
â€œindexâ€: 0
}
]
]
},
â€œNotifica Report Completatoâ€: {
â€œmainâ€: [
[
{
â€œnodeâ€: â€œLog Eventoâ€,
â€œtypeâ€: â€œmainâ€,
â€œindexâ€: 0
}
]
]
}
},
â€œsettingsâ€: {
â€œexecutionOrderâ€: â€œv1â€
}
}
