{
â€œnameâ€: â€œCER Magliano - Workflow Principaleâ€,
â€œnodesâ€: [
{
â€œparametersâ€: {
â€œruleâ€: {
â€œintervalâ€: [
{
â€œfieldâ€: â€œminutesâ€,
â€œminutesIntervalâ€: 60
}
]
}
},
â€œnameâ€: â€œTrigger Orarioâ€,
â€œtypeâ€: â€œn8n-nodes-base.scheduleTriggerâ€,
â€œpositionâ€: [250, 300],
â€œidâ€: â€œtrigger-orarioâ€
},
{
â€œparametersâ€: {
â€œhttpMethodâ€: â€œPOSTâ€,
â€œpathâ€: â€œdati-orariâ€,
â€œoptionsâ€: {}
},
â€œnameâ€: â€œWebhook Dati Home Assistantâ€,
â€œtypeâ€: â€œn8n-nodes-base.webhookâ€,
â€œpositionâ€: [250, 500],
â€œwebhookIdâ€: â€œcer-magliano-datiâ€,
â€œidâ€: â€œwebhook-haâ€
},
{
â€œparametersâ€: {
â€œauthenticationâ€: â€œpredefinedCredentialTypeâ€,
â€œnodeCredentialTypeâ€: â€œpostgresâ€,
â€œoperationâ€: â€œexecuteQueryâ€,
â€œqueryâ€: â€œSELECT m.id, m.codice_membro, m.nome, m.pod FROM membri m WHERE m.attivo = trueâ€
},
â€œnameâ€: â€œCarica Membri Attiviâ€,
â€œtypeâ€: â€œn8n-nodes-base.postgresâ€,
â€œpositionâ€: [450, 300],
â€œcredentialsâ€: {
â€œpostgresâ€: {
â€œidâ€: â€œ1â€,
â€œnameâ€: â€œPostgreSQL CERâ€
}
},
â€œidâ€: â€œload-membriâ€
},
{
â€œparametersâ€: {
â€œurlâ€: â€œ={{ $json.ha_endpoint }}/api/states/sensor.produzione_orariaâ€,
â€œauthenticationâ€: â€œpredefinedCredentialTypeâ€,
â€œnodeCredentialTypeâ€: â€œhttpHeaderAuthâ€,
â€œoptionsâ€: {}
},
â€œnameâ€: â€œRichiedi Dati HA - Produzioneâ€,
â€œtypeâ€: â€œn8n-nodes-base.httpRequestâ€,
â€œpositionâ€: [650, 200],
â€œcredentialsâ€: {
â€œhttpHeaderAuthâ€: {
â€œidâ€: â€œ2â€,
â€œnameâ€: â€œHome Assistant Authâ€
}
},
â€œidâ€: â€œfetch-produzioneâ€
},
{
â€œparametersâ€: {
â€œurlâ€: â€œ={{ $json.ha_endpoint }}/api/states/sensor.consumo_orarioâ€,
â€œauthenticationâ€: â€œpredefinedCredentialTypeâ€,
â€œnodeCredentialTypeâ€: â€œhttpHeaderAuthâ€
},
â€œnameâ€: â€œRichiedi Dati HA - Consumoâ€,
â€œtypeâ€: â€œn8n-nodes-base.httpRequestâ€,
â€œpositionâ€: [650, 400],
â€œcredentialsâ€: {
â€œhttpHeaderAuthâ€: {
â€œidâ€: â€œ2â€,
â€œnameâ€: â€œHome Assistant Authâ€
}
},
â€œidâ€: â€œfetch-consumoâ€
},
{
â€œparametersâ€: {
â€œjsCodeâ€: â€œconst items = $input.all();\nconst timestamp = new Date();\ntimestamp.setMinutes(0, 0, 0);\n\nlet produzioneTotale = 0;\nlet consumoTotale = 0;\n\nfor (const item of items) {\n  if (item.json.tipo === â€˜produzioneâ€™) {\n    produzioneTotale += parseFloat(item.json.valore) || 0;\n  } else if (item.json.tipo === â€˜consumoâ€™) {\n    consumoTotale += parseFloat(item.json.valore) || 0;\n  }\n}\n\nconst energiaCondivisa = Math.min(produzioneTotale, consumoTotale);\nconst energiaImmessa = Math.max(0, produzioneTotale - consumoTotale);\nconst energiaPrelevata = Math.max(0, consumoTotale - produzioneTotale);\nconst percentualeAutoconsumo = consumoTotale > 0 \n  ? (energiaCondivisa / consumoTotale * 100).toFixed(2) \n  : 0;\n\n// Tariffa incentivo CER (dal TIAD + premio autoconsumo)\nconst tariffaIncentivo = 0.119; // â‚¬/kWh\nconst valoreIncentivo = (energiaCondivisa * tariffaIncentivo).toFixed(2);\n\nreturn [{\n  json: {\n    timestamp: timestamp.toISOString(),\n    produzione_totale_kwh: produzioneTotale.toFixed(3),\n    consumo_totale_kwh: consumoTotale.toFixed(3),\n    energia_condivisa_kwh: energiaCondivisa.toFixed(3),\n    energia_immessa_rete_kwh: energiaImmessa.toFixed(3),\n    energia_prelevata_rete_kwh: energiaPrelevata.toFixed(3),\n    percentuale_autoconsumo: percentualeAutoconsumo,\n    tariffa_incentivo_euro_kwh: tariffaIncentivo,\n    valore_incentivo_euro: valoreIncentivo,\n    numero_membri_attivi: items.filter(i => i.json.membro_id).length\n  }\n}];â€
},
â€œnameâ€: â€œCalcola Energia Condivisaâ€,
â€œtypeâ€: â€œn8n-nodes-base.codeâ€,
â€œpositionâ€: [850, 300],
â€œidâ€: â€œcalc-energiaâ€
},
{
â€œparametersâ€: {
â€œoperationâ€: â€œexecuteQueryâ€,
â€œqueryâ€: â€œINSERT INTO energia_condivisa_oraria (\n  timestamp, \n  produzione_totale_kwh, \n  consumo_totale_kwh,\n  energia_condivisa_kwh,\n  energia_immessa_rete_kwh,\n  energia_prelevata_rete_kwh,\n  percentuale_autoconsumo,\n  tariffa_incentivo_euro_kwh,\n  valore_incentivo_euro,\n  numero_membri_attivi\n) VALUES (\n  â€˜{{ $json.timestamp }}â€™,\n  {{ $json.produzione_totale_kwh }},\n  {{ $json.consumo_totale_kwh }},\n  {{ $json.energia_condivisa_kwh }},\n  {{ $json.energia_immessa_rete_kwh }},\n  {{ $json.energia_prelevata_rete_kwh }},\n  {{ $json.percentuale_autoconsumo }},\n  {{ $json.tariffa_incentivo_euro_kwh }},\n  {{ $json.valore_incentivo_euro }},\n  {{ $json.numero_membri_attivi }}\n) ON CONFLICT (timestamp) DO UPDATE SET\n  produzione_totale_kwh = EXCLUDED.produzione_totale_kwh,\n  consumo_totale_kwh = EXCLUDED.consumo_totale_kwh,\n  energia_condivisa_kwh = EXCLUDED.energia_condivisa_kwh,\n  energia_immessa_rete_kwh = EXCLUDED.energia_immessa_rete_kwh,\n  energia_prelevata_rete_kwh = EXCLUDED.energia_prelevata_rete_kwh,\n  percentuale_autoconsumo = EXCLUDED.percentuale_autoconsumo,\n  valore_incentivo_euro = EXCLUDED.valore_incentivo_euroâ€
},
â€œnameâ€: â€œSalva Energia Condivisa DBâ€,
â€œtypeâ€: â€œn8n-nodes-base.postgresâ€,
â€œpositionâ€: [1050, 300],
â€œcredentialsâ€: {
â€œpostgresâ€: {
â€œidâ€: â€œ1â€,
â€œnameâ€: â€œPostgreSQL CERâ€
}
},
â€œidâ€: â€œsave-energia-dbâ€
},
{
â€œparametersâ€: {
â€œoperationâ€: â€œexecuteQueryâ€,
â€œqueryâ€: â€œSELECT calcola_energia_condivisa(â€™{{ $json.timestamp }}â€™)â€
},
â€œnameâ€: â€œTrigger Calcolo Ripartizioneâ€,
â€œtypeâ€: â€œn8n-nodes-base.postgresâ€,
â€œpositionâ€: [1250, 300],
â€œcredentialsâ€: {
â€œpostgresâ€: {
â€œidâ€: â€œ1â€,
â€œnameâ€: â€œPostgreSQL CERâ€
}
},
â€œidâ€: â€œcalc-ripartizioneâ€
},
{
â€œparametersâ€: {
â€œoperationâ€: â€œexecuteQueryâ€,
â€œqueryâ€: â€œSELECT ripartisci_incentivi_orari(â€™{{ $json.timestamp }}â€™)â€
},
â€œnameâ€: â€œRipartisci Incentiviâ€,
â€œtypeâ€: â€œn8n-nodes-base.postgresâ€,
â€œpositionâ€: [1450, 300],
â€œcredentialsâ€: {
â€œpostgresâ€: {
â€œidâ€: â€œ1â€,
â€œnameâ€: â€œPostgreSQL CERâ€
}
},
â€œidâ€: â€œripartisci-incentiviâ€
},
{
â€œparametersâ€: {
â€œchatIdâ€: â€œ{{ $json.telegram_chat_id }}â€,
â€œtextâ€: â€œâœ… *Aggiornamento Orario CER Magliano*\n\nğŸ”† Produzione: {{ $json.produzione_totale_kwh }} kWh\nâš¡ Consumo: {{ $json.consumo_totale_kwh }} kWh\nğŸ”„ Energia Condivisa: {{ $json.energia_condivisa_kwh }} kWh\nğŸ“Š Autoconsumo: {{ $json.percentuale_autoconsumo }}%\nğŸ’° Incentivi orari: â‚¬{{ $json.valore_incentivo_euro }}\nğŸ‘¥ Membri attivi: {{ $json.numero_membri_attivi }}â€,
â€œadditionalFieldsâ€: {
â€œparse_modeâ€: â€œMarkdownâ€
}
},
â€œnameâ€: â€œNotifica Telegramâ€,
â€œtypeâ€: â€œn8n-nodes-base.telegramâ€,
â€œpositionâ€: [1650, 300],
â€œcredentialsâ€: {
â€œtelegramApiâ€: {
â€œidâ€: â€œ3â€,
â€œnameâ€: â€œTelegram Bot CERâ€
}
},
â€œidâ€: â€œnotify-telegramâ€
},
{
â€œparametersâ€: {
â€œurlâ€: â€œhttps://api.influxdb.com/writeâ€,
â€œmethodâ€: â€œPOSTâ€,
â€œauthenticationâ€: â€œpredefinedCredentialTypeâ€,
â€œnodeCredentialTypeâ€: â€œhttpHeaderAuthâ€,
â€œsendBodyâ€: true,
â€œbodyParametersâ€: {
â€œparametersâ€: [
{
â€œnameâ€: â€œdbâ€,
â€œvalueâ€: â€œcer_maglianoâ€
}
]
},
â€œoptionsâ€: {
â€œbodyContentTypeâ€: â€œrawâ€,
â€œrawBodyâ€: â€œenergia_condivisa,location=magliano produzione={{ $json.produzione_totale_kwh }},consumo={{ $json.consumo_totale_kwh }},condivisa={{ $json.energia_condivisa_kwh }},autoconsumo={{ $json.percentuale_autoconsumo }} {{ new Date($json.timestamp).getTime() * 1000000 }}â€
}
},
â€œnameâ€: â€œInvia a InfluxDBâ€,
â€œtypeâ€: â€œn8n-nodes-base.httpRequestâ€,
â€œpositionâ€: [1650, 450],
â€œcredentialsâ€: {
â€œhttpHeaderAuthâ€: {
â€œidâ€: â€œ4â€,
â€œnameâ€: â€œInfluxDB Authâ€
}
},
â€œidâ€: â€œsend-influxâ€
},
{
â€œparametersâ€: {
â€œconditionsâ€: {
â€œnumberâ€: [
{
â€œvalue1â€: â€œ={{ $json.energia_condivisa_kwh }}â€,
â€œoperationâ€: â€œlargerâ€,
â€œvalue2â€: 0
}
]
}
},
â€œnameâ€: â€œIF Energia Condivisa > 0â€,
â€œtypeâ€: â€œn8n-nodes-base.ifâ€,
â€œpositionâ€: [1250, 450],
â€œidâ€: â€œif-energiaâ€
},
{
â€œparametersâ€: {
â€œconditionsâ€: {
â€œnumberâ€: [
{
â€œvalue1â€: â€œ={{ $json.percentuale_autoconsumo }}â€,
â€œoperationâ€: â€œsmallerâ€,
â€œvalue2â€: 50
}
]
}
},
â€œnameâ€: â€œIF Autoconsumo Bassoâ€,
â€œtypeâ€: â€œn8n-nodes-base.ifâ€,
â€œpositionâ€: [1050, 500],
â€œidâ€: â€œif-autoconsumo-bassoâ€
},
{
â€œparametersâ€: {
â€œchatIdâ€: â€œ{{ $json.telegram_admin_id }}â€,
â€œtextâ€: â€œâš ï¸ *Alert Autoconsumo Basso*\n\nAutoconsumo: {{ $json.percentuale_autoconsumo }}%\nRaccomandazione: valutare installazione batterie o ottimizzazione carichi differibiliâ€,
â€œadditionalFieldsâ€: {
â€œparse_modeâ€: â€œMarkdownâ€
}
},
â€œnameâ€: â€œAlert Autoconsumoâ€,
â€œtypeâ€: â€œn8n-nodes-base.telegramâ€,
â€œpositionâ€: [1250, 600],
â€œcredentialsâ€: {
â€œtelegramApiâ€: {
â€œidâ€: â€œ3â€,
â€œnameâ€: â€œTelegram Bot CERâ€
}
},
â€œidâ€: â€œalert-autoconsumoâ€
}
],
â€œconnectionsâ€: {
â€œTrigger Orarioâ€: {
â€œmainâ€: [
[
{
â€œnodeâ€: â€œCarica Membri Attiviâ€,
â€œtypeâ€: â€œmainâ€,
â€œindexâ€: 0
}
]
]
},
â€œCarica Membri Attiviâ€: {
â€œmainâ€: [
[
{
â€œnodeâ€: â€œRichiedi Dati HA - Produzioneâ€,
â€œtypeâ€: â€œmainâ€,
â€œindexâ€: 0
},
{
â€œnodeâ€: â€œRichiedi Dati HA - Consumoâ€,
â€œtypeâ€: â€œmainâ€,
â€œindexâ€: 0
}
]
]
},
â€œRichiedi Dati HA - Produzioneâ€: {
â€œmainâ€: [
[
{
â€œnodeâ€: â€œCalcola Energia Condivisaâ€,
â€œtypeâ€: â€œmainâ€,
â€œindexâ€: 0
}
]
]
},
â€œRichiedi Dati HA - Consumoâ€: {
â€œmainâ€: [
[
{
â€œnodeâ€: â€œCalcola Energia Condivisaâ€,
â€œtypeâ€: â€œmainâ€,
â€œindexâ€: 0
}
]
]
},
â€œCalcola Energia Condivisaâ€: {
â€œmainâ€: [
[
{
â€œnodeâ€: â€œSalva Energia Condivisa DBâ€,
â€œtypeâ€: â€œmainâ€,
â€œindexâ€: 0
},
{
â€œnodeâ€: â€œIF Autoconsumo Bassoâ€,
â€œtypeâ€: â€œmainâ€,
â€œindexâ€: 0
}
]
]
},
â€œSalva Energia Condivisa DBâ€: {
â€œmainâ€: [
[
{
â€œnodeâ€: â€œTrigger Calcolo Ripartizioneâ€,
â€œtypeâ€: â€œmainâ€,
â€œindexâ€: 0
}
]
]
},
â€œTrigger Calcolo Ripartizioneâ€: {
â€œmainâ€: [
[
{
â€œnodeâ€: â€œRipartisci Incentiviâ€,
â€œtypeâ€: â€œmainâ€,
â€œindexâ€: 0
},
{
â€œnodeâ€: â€œIF Energia Condivisa > 0â€,
â€œtypeâ€: â€œmainâ€,
â€œindexâ€: 0
}
]
]
},
â€œRipartisci Incentiviâ€: {
â€œmainâ€: [
[
{
â€œnodeâ€: â€œNotifica Telegramâ€,
â€œtypeâ€: â€œmainâ€,
â€œindexâ€: 0
}
]
]
},
â€œIF Energia Condivisa > 0â€: {
â€œmainâ€: [
[
{
â€œnodeâ€: â€œInvia a InfluxDBâ€,
â€œtypeâ€: â€œmainâ€,
â€œindexâ€: 0
}
]
]
},
â€œIF Autoconsumo Bassoâ€: {
â€œmainâ€: [
[
{
â€œnodeâ€: â€œAlert Autoconsumoâ€,
â€œtypeâ€: â€œmainâ€,
â€œindexâ€: 0
}
]
]
},
â€œWebhook Dati Home Assistantâ€: {
â€œmainâ€: [
[
{
â€œnodeâ€: â€œCalcola Energia Condivisaâ€,
â€œtypeâ€: â€œmainâ€,
â€œindexâ€: 0
}
]
]
}
},
â€œsettingsâ€: {
â€œexecutionOrderâ€: â€œv1â€
}
}
