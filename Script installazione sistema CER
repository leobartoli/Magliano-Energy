#!/bin/bash

#############################################

# Script di Installazione Sistema CER

# Comune di Magliano in Toscana

# 

# Questo script installa e configura:

# - PostgreSQL + TimescaleDB

# - InfluxDB

# - n8n

# - Grafana

# - MQTT Mosquitto

# - Nginx + SSL

# 

# Requisiti: Ubuntu Server 22.04 LTS

#############################################

set -e  # Exit on error

# Colori per output

RED=’\033[0;31m’
GREEN=’\033[0;32m’
YELLOW=’\033[1;33m’
NC=’\033[0m’ # No Color

# Variabili configurazione

DOMAIN=“cermagliano.local”
EMAIL=“energia@comune.magliano.gr.it”
DB_NAME=“cer_magliano”
DB_USER=“cer_admin”
DB_PASSWORD=$(openssl rand -base64 32)
N8N_PASSWORD=$(openssl rand -base64 16)
GRAFANA_PASSWORD=$(openssl rand -base64 16)

# Funzioni helper

log_info() {
echo -e “${GREEN}[INFO]${NC} $1”
}

log_warn() {
echo -e “${YELLOW}[WARN]${NC} $1”
}

log_error() {
echo -e “${RED}[ERROR]${NC} $1”
}

check_root() {
if [[ $EUID -ne 0 ]]; then
log_error “Questo script deve essere eseguito come root”
exit 1
fi
}

print_banner() {
cat << “EOF”
╔═══════════════════════════════════════════════════════╗
║                                                       ║
║   Sistema CER - Magliano in Toscana                  ║
║   Installazione Automatica                           ║
║                                                       ║
╚═══════════════════════════════════════════════════════╝
EOF
echo “”
}

# 1. Controlli preliminari

check_system() {
log_info “Controllo sistema…”

```
# Verifica OS
if ! grep -q "Ubuntu 22.04" /etc/os-release; then
    log_warn "Questo script è ottimizzato per Ubuntu 22.04 LTS"
fi

# Verifica connessione internet
if ! ping -c 1 google.com &> /dev/null; then
    log_error "Nessuna connessione internet disponibile"
    exit 1
fi

# Verifica spazio disco (min 50GB)
SPACE=$(df -BG / | awk 'NR==2 {print $4}' | sed 's/G//')
if [ "$SPACE" -lt 50 ]; then
    log_warn "Spazio disco insufficiente (< 50GB). Procedere comunque? (y/n)"
    read -r response
    if [[ ! "$response" =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

log_info "✓ Sistema verificato"
```

}

# 2. Aggiornamento sistema

update_system() {
log_info “Aggiornamento sistema operativo…”
apt update && apt upgrade -y
apt install -y curl wget git vim ufw fail2ban htop software-properties-common
log_info “✓ Sistema aggiornato”
}

# 3. Configurazione firewall

setup_firewall() {
log_info “Configurazione firewall…”

```
ufw --force reset
ufw default deny incoming
ufw default allow outgoing
ufw allow 22/tcp   # SSH
ufw allow 80/tcp   # HTTP
ufw allow 443/tcp  # HTTPS
ufw allow 1883/tcp # MQTT
ufw --force enable

log_info "✓ Firewall configurato"
```

}

# 4. Installazione PostgreSQL + TimescaleDB

install_postgresql() {
log_info “Installazione PostgreSQL 14…”

```
# Installa PostgreSQL
apt install -y postgresql-14 postgresql-contrib-14

# Aggiungi repository TimescaleDB
echo "deb https://packagecloud.io/timescale/timescaledb/ubuntu/ $(lsb_release -c -s) main" | \
    tee /etc/apt/sources.list.d/timescaledb.list
wget --quiet -O - https://packagecloud.io/timescale/timescaledb/gpgkey | apt-key add -
apt update

# Installa TimescaleDB
apt install -y timescaledb-2-postgresql-14

# Configura TimescaleDB
timescaledb-tune --quiet --yes

# Restart PostgreSQL
systemctl restart postgresql

log_info "✓ PostgreSQL + TimescaleDB installato"
```

}

# 5. Configurazione database CER

setup_database() {
log_info “Configurazione database CER…”

```
# Crea database e utente
sudo -u postgres psql << EOF
```

CREATE DATABASE $DB_NAME;
CREATE USER $DB_USER WITH ENCRYPTED PASSWORD ‘$DB_PASSWORD’;
GRANT ALL PRIVILEGES ON DATABASE $DB_NAME TO $DB_USER;
\c $DB_NAME
CREATE EXTENSION IF NOT EXISTS timescaledb;
CREATE EXTENSION IF NOT EXISTS “uuid-ossp”;
ALTER DATABASE $DB_NAME SET timezone TO ‘Europe/Rome’;
EOF

```
# Salva credenziali
cat > /root/.cer_credentials << EOF
```

# Credenziali Database CER

DB_NAME=$DB_NAME
DB_USER=$DB_USER
DB_PASSWORD=$DB_PASSWORD
DB_HOST=localhost
DB_PORT=5432
EOF

```
chmod 600 /root/.cer_credentials

log_info "✓ Database configurato"
log_info "   Database: $DB_NAME"
log_info "   User: $DB_USER"
log_info "   Password salvata in: /root/.cer_credentials"
```

}

# 6. Installazione InfluxDB

install_influxdb() {
log_info “Installazione InfluxDB 2.x…”

```
# Aggiungi repository
wget -q https://repos.influxdata.com/influxdata-archive_compat.key
echo '393e8779c89ac8d958f81f942f9ad7fb82a25e133faddaf92e15b16e6ac9ce4c influxdata-archive_compat.key' | \
    sha256sum -c && cat influxdata-archive_compat.key | \
    gpg --dearmor | tee /etc/apt/trusted.gpg.d/influxdata-archive_compat.gpg > /dev/null
echo 'deb [signed-by=/etc/apt/trusted.gpg.d/influxdata-archive_compat.gpg] https://repos.influxdata.com/debian stable main' | \
    tee /etc/apt/sources.list.d/influxdata.list

apt update && apt install -y influxdb2

# Avvia InfluxDB
systemctl enable influxdb
systemctl start influxdb

log_info "✓ InfluxDB installato"
log_info "   Setup iniziale: http://localhost:8086"
```

}

# 7. Installazione MQTT Mosquitto

install_mqtt() {
log_info “Installazione MQTT Mosquitto…”

```
apt install -y mosquitto mosquitto-clients

# Configurazione base
cat > /etc/mosquitto/conf.d/cer.conf << EOF
```

listener 1883
allow_anonymous false
password_file /etc/mosquitto/passwd

# Log

log_dest file /var/log/mosquitto/mosquitto.log
log_type error
log_type warning
log_type notice
log_type information
EOF

```
# Crea utente MQTT
MQTT_PASSWORD=$(openssl rand -base64 16)
mosquitto_passwd -c -b /etc/mosquitto/passwd cer_mqtt "$MQTT_PASSWORD"

# Salva credenziali
cat >> /root/.cer_credentials << EOF
```

# Credenziali MQTT

MQTT_USER=cer_mqtt
MQTT_PASSWORD=$MQTT_PASSWORD
MQTT_HOST=localhost
MQTT_PORT=1883
EOF

```
systemctl restart mosquitto

log_info "✓ MQTT Mosquitto installato"
```

}

# 8. Installazione Docker (per n8n)

install_docker() {
log_info “Installazione Docker…”

```
# Installa Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sh get-docker.sh
rm get-docker.sh

# Installa Docker Compose
curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" \
    -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose

# Avvia Docker
systemctl enable docker
systemctl start docker

log_info "✓ Docker installato"
```

}

# 9. Installazione n8n

install_n8n() {
log_info “Installazione n8n…”

```
# Crea directory
mkdir -p /opt/n8n
cd /opt/n8n

# Crea docker-compose.yml
cat > docker-compose.yml << EOF
```

version: ‘3.7’

services:
n8n:
image: n8nio/n8n:latest
container_name: n8n-cer
restart: unless-stopped
ports:
- “127.0.0.1:5678:5678”
environment:
- N8N_BASIC_AUTH_ACTIVE=true
- N8N_BASIC_AUTH_USER=admin
- N8N_BASIC_AUTH_PASSWORD=$N8N_PASSWORD
- N8N_HOST=$DOMAIN
- N8N_PROTOCOL=https
- NODE_ENV=production
- WEBHOOK_URL=https://$DOMAIN/
- GENERIC_TIMEZONE=Europe/Rome
- DB_TYPE=postgresdb
- DB_POSTGRESDB_HOST=host.docker.internal
- DB_POSTGRESDB_PORT=5432
- DB_POSTGRESDB_DATABASE=n8n
- DB_POSTGRESDB_USER=$DB_USER
- DB_POSTGRESDB_PASSWORD=$DB_PASSWORD
volumes:
- ./n8n_data:/home/node/.n8n
- ./workflows:/workflows
extra_hosts:
- “host.docker.internal:host-gateway”

volumes:
n8n_data:
EOF

```
# Crea database per n8n
sudo -u postgres psql << EOF
```

CREATE DATABASE n8n;
GRANT ALL PRIVILEGES ON DATABASE n8n TO $DB_USER;
EOF

```
# Avvia n8n
docker-compose up -d

# Salva credenziali
cat >> /root/.cer_credentials << EOF
```

# Credenziali n8n

N8N_URL=https://$DOMAIN
N8N_USER=admin
N8N_PASSWORD=$N8N_PASSWORD
EOF

```
log_info "✓ n8n installato"
log_info "   URL: http://localhost:5678"
log_info "   User: admin"
```

}

# 10. Installazione Grafana

install_grafana() {
log_info “Installazione Grafana…”

```
# Aggiungi repository
wget -q -O - https://packages.grafana.com/gpg.key | apt-key add -
add-apt-repository "deb https://packages.grafana.com/oss/deb stable main"
apt update
apt install -y grafana

# Configura Grafana
cat > /etc/grafana/grafana.ini << EOF
```

[server]
protocol = http
http_addr = 127.0.0.1
http_port = 3000
domain = $DOMAIN
root_url = https://$DOMAIN/grafana

[security]
admin_user = admin
admin_password = $GRAFANA_PASSWORD

[auth.anonymous]
enabled = false

[database]
type = postgres
host = localhost:5432
name = grafana
user = $DB_USER
password = $DB_PASSWORD

[log]
mode = console file
level = info
EOF

```
# Crea database per Grafana
sudo -u postgres psql << EOF
```

CREATE DATABASE grafana;
GRANT ALL PRIVILEGES ON DATABASE grafana TO $DB_USER;
EOF

```
# Avvia Grafana
systemctl enable grafana-server
systemctl start grafana-server

# Salva credenziali
cat >> /root/.cer_credentials << EOF
```

# Credenziali Grafana

GRAFANA_URL=https://$DOMAIN/grafana
GRAFANA_USER=admin
GRAFANA_PASSWORD=$GRAFANA_PASSWORD
EOF

```
log_info "✓ Grafana installato"
log_info "   URL: http://localhost:3000"
```

}

# 11. Installazione Nginx + SSL

install_nginx() {
log_info “Installazione Nginx…”

```
apt install -y nginx certbot python3-certbot-nginx

# Configurazione Nginx
cat > /etc/nginx/sites-available/cer << EOF
```

upstream n8n {
server 127.0.0.1:5678;
}

upstream grafana {
server 127.0.0.1:3000;
}

server {
listen 80;
server_name $DOMAIN;

```
# Reindirizza a HTTPS
return 301 https://\$server_name\$request_uri;
```

}

server {
listen 443 ssl http2;
server_name $DOMAIN;

```
# SSL (certbot aggiungerà i certificati)

# n8n
location / {
    proxy_pass http://n8n;
    proxy_set_header Connection '';
    proxy_http_version 1.1;
    chunked_transfer_encoding off;
    proxy_buffering off;
    proxy_cache off;
    proxy_set_header Host \$host;
    proxy_set_header X-Real-IP \$remote_addr;
    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto \$scheme;
}

# Grafana
location /grafana/ {
    proxy_pass http://grafana/;
    proxy_set_header Host \$host;
    proxy_set_header X-Real-IP \$remote_addr;
    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto \$scheme;
}

# Sicurezza
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
```

}
EOF

```
# Abilita configurazione
ln -sf /etc/nginx/sites-available/cer /etc/nginx/sites-enabled/
rm -f /etc/nginx/sites-enabled/default

# Test configurazione
nginx -t

# Avvia Nginx
systemctl enable nginx
systemctl restart nginx

log_info "✓ Nginx installato"
```

}

# 12. Setup SSL con Let’s Encrypt

setup_ssl() {
log_info “Configurazione SSL…”
log_warn “Assicurati che il dominio $DOMAIN punti a questo server”
read -p “Procedere con certbot? (y/n) “ -n 1 -r
echo

```
if [[ $REPLY =~ ^[Yy]$ ]]; then
    certbot --nginx -d "$DOMAIN" --non-interactive --agree-tos -m "$EMAIL"
    log_info "✓ SSL configurato"
else
    log_warn "SSL non configurato. Eseguire manualmente: certbot --nginx -d $DOMAIN"
fi
```

}

# 13. Import schema database

import_schema() {
log_info “Vuoi importare lo schema database CER? (y/n)”
read -r response

```
if [[ "$response" =~ ^[Yy]$ ]]; then
    log_info "Incolla il contenuto dello schema SQL e premi Ctrl+D quando finito:"
    cat > /tmp/schema_cer.sql
    
    sudo -u postgres psql -d "$DB_NAME" -f /tmp/schema_cer.sql
    rm /tmp/schema_cer.sql
    
    log_info "✓ Schema database importato"
fi
```

}

# 14. Configurazione backup automatico

setup_backup() {
log_info “Configurazione backup automatico…”

```
# Crea directory backup
mkdir -p /backup/cer/{daily,weekly,monthly}

# Script backup
cat > /usr/local/bin/cer-backup.sh << 'EOF'
```

#!/bin/bash
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR=”/backup/cer/daily”

# Backup database

pg_dump -U cer_admin cer_magliano | gzip > “$BACKUP_DIR/cer_db_$TIMESTAMP.sql.gz”

# Backup n8n workflows

tar -czf “$BACKUP_DIR/n8n_workflows_$TIMESTAMP.tar.gz” -C /opt/n8n/workflows .

# Backup Grafana dashboards

tar -czf “$BACKUP_DIR/grafana_$TIMESTAMP.tar.gz” -C /var/lib/grafana dashboards

# Retention (30 giorni daily)

find /backup/cer/daily -name “*.gz” -mtime +30 -delete
find /backup/cer/daily -name “*.tar.gz” -mtime +30 -delete

echo “Backup completato: $TIMESTAMP”
EOF

```
chmod +x /usr/local/bin/cer-backup.sh

# Crontab
(crontab -l 2>/dev/null; echo "0 2 * * * /usr/local/bin/cer-backup.sh >> /var/log/cer-backup.log 2>&1") | crontab -

log_info "✓ Backup automatico configurato (ore 02:00)"
```

}

# 15. Setup monitoraggio sistema

setup_monitoring() {
log_info “Configurazione monitoraggio sistema…”

```
# Script controllo servizi
cat > /usr/local/bin/cer-healthcheck.sh << 'EOF'
```

#!/bin/bash

services=(“postgresql” “influxdb” “mosquitto” “docker” “nginx” “grafana-server”)

for service in “${services[@]}”; do
if ! systemctl is-active –quiet “$service”; then
echo “ALERT: $service non è attivo!” |   
mail -s “CER Alert: $service down” energia@comune.magliano.gr.it
fi
done
EOF

```
chmod +x /usr/local/bin/cer-healthcheck.sh

# Crontab ogni 15 minuti
(crontab -l 2>/dev/null; echo "*/15 * * * * /usr/local/bin/cer-healthcheck.sh") | crontab -

log_info "✓ Monitoraggio configurato"
```

}

# 16. Stampa riepilogo finale

print_summary() {
echo “”
echo “╔═══════════════════════════════════════════════════════╗”
echo “║                                                       ║”
echo “║   ✓ Installazione Completata!                        ║”
echo “║                                                       ║”
echo “╚═══════════════════════════════════════════════════════╝”
echo “”
log_info “Servizi installati e attivi:”
echo “  • PostgreSQL + TimescaleDB”
echo “  • InfluxDB (http://localhost:8086)”
echo “  • MQTT Mosquitto”
echo “  • n8n (https://$DOMAIN)”
echo “  • Grafana (https://$DOMAIN/grafana)”
echo “  • Nginx + SSL”
echo “”
log_info “Credenziali salvate in: /root/.cer_credentials”
echo “”
log_warn “PROSSIMI PASSI:”
echo “  1. Configura InfluxDB: http://localhost:8086”
echo “  2. Importa workflow n8n”
echo “  3. Configura datasource Grafana”
echo “  4. Importa dashboard Grafana”
echo “  5. Configura Home Assistant su Raspberry Pi”
echo “  6. Testa connessione MQTT”
echo “”
log_info “Documentazione completa in: /opt/cer/docs/”
echo “”
}

# MAIN EXECUTION

main() {
print_banner
check_root

```
log_info "Inizio installazione sistema CER..."
echo ""

check_system
update_system
setup_firewall
install_postgresql
setup_database
install_influxdb
install_mqtt
install_docker
install_n8n
install_grafana
install_nginx
setup_ssl
import_schema
setup_backup
setup_monitoring

print_summary
```

}

# Esegui main

main “$@”
