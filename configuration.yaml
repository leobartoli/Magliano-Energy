# configuration.yaml - Home Assistant Comune di Magliano in Toscana

homeassistant:
name: CER Magliano - Comune
latitude: 42.5944
longitude: 11.2903
elevation: 128
unit_system: metric
time_zone: Europe/Rome
currency: EUR
country: IT

# Database per storico lungo

recorder:
db_url: postgresql://ha_user:password@localhost/cer_magliano
purge_keep_days: 730
include:
domains:
- sensor
- switch
entities:
- sensor.produzione_totale_comune
- sensor.consumo_totale_comune
- sensor.energia_condivisa

# InfluxDB per analisi avanzate

influxdb:
host: localhost
port: 8086
database: cer_magliano
username: admin
password: password
max_retries: 3
default_measurement: state
include:
entities:
- sensor.produzione_*
- sensor.consumo_*
- sensor.prezzo_pun

# MQTT per comunicazione con n8n e altri sistemi

mqtt:
broker: localhost
port: 1883
username: cer_mqtt
password: password
discovery: true
birth_message:
topic: â€˜homeassistant/statusâ€™
payload: â€˜onlineâ€™

# RESTful API per n8n

rest_command:
invia_dati_n8n:
url: â€˜https://n8n.cermagliano.local/webhook/dati-orariâ€™
method: POST
headers:
Authorization: â€˜Bearer TOKEN_SICUROâ€™
payload: >
{
â€œtimestampâ€: â€œ{{ now().isoformat() }}â€,
â€œsedeâ€: â€œ{{ sede }}â€,
â€œproduzione_kwhâ€: {{ produzione }},
â€œconsumo_kwhâ€: {{ consumo }},
â€œautoconsumo_kwhâ€: {{ autoconsumo }}
}

# MODBUS per lettura inverter fotovoltaici

modbus:

- name: inverter_municipio
  type: tcp
  host: 192.168.1.100
  port: 502
  sensors:
  - name: â€œProduzione Municipioâ€
    address: 40083
    unit_of_measurement: â€œWâ€
    device_class: power
    state_class: measurement
    scale: 0.1
    precision: 1
  - name: â€œEnergia Totale Municipioâ€
    address: 40093
    unit_of_measurement: â€œkWhâ€
    device_class: energy
    state_class: total_increasing
    scale: 0.1
    precision: 2
- name: inverter_scuola_elementare
  type: tcp
  host: 192.168.1.101
  port: 502
  sensors:
  - name: â€œProduzione Scuola Elementareâ€
    address: 40083
    unit_of_measurement: â€œWâ€
    device_class: power
    state_class: measurement
    scale: 0.1
- name: inverter_palestra
  type: tcp
  host: 192.168.1.102
  port: 502
  sensors:
  - name: â€œProduzione Palestraâ€
    address: 40083
    unit_of_measurement: â€œWâ€
    device_class: power
    state_class: measurement
    scale: 0.1

# Smart meter e contatori Enel/E-Distribuzione

sensor:

# Prezzo PUN da API ARERA

- platform: rest
  name: Prezzo PUN Orario
  resource: https://api.example.com/pun/current
  value_template: â€˜{{ value_json.price }}â€™
  unit_of_measurement: â€˜â‚¬/kWhâ€™
  scan_interval: 3600

# Aggregazione produzione totale comune

- platform: template
  sensors:
  produzione_totale_comune:
  friendly_name: â€œProduzione Totale Comuneâ€
  unit_of_measurement: â€œWâ€
  device_class: power
  value_template: >
  {{ states(â€˜sensor.produzione_municipioâ€™)|float(0) +
  states(â€˜sensor.produzione_scuola_elementareâ€™)|float(0) +
  states(â€˜sensor.produzione_palestraâ€™)|float(0) }}
  
  # Consumo totale edifici comunali
  
  consumo_totale_comune:
  friendly_name: â€œConsumo Totale Comuneâ€
  unit_of_measurement: â€œWâ€
  device_class: power
  value_template: >
  {{ states(â€˜sensor.consumo_municipioâ€™)|float(0) +
  states(â€˜sensor.consumo_scuola_elementareâ€™)|float(0) +
  states(â€˜sensor.consumo_palestraâ€™)|float(0) +
  states(â€˜sensor.consumo_illuminazione_pubblicaâ€™)|float(0) }}
  
  # Autoconsumo istantaneo
  
  autoconsumo_istantaneo:
  friendly_name: â€œAutoconsumo Istantaneoâ€
  unit_of_measurement: â€œWâ€
  device_class: power
  value_template: >
  {% set prod = states(â€˜sensor.produzione_totale_comuneâ€™)|float(0) %}
  {% set cons = states(â€˜sensor.consumo_totale_comuneâ€™)|float(0) %}
  {{ [prod, cons]|min }}
  
  # Energia immessa in rete
  
  energia_immessa:
  friendly_name: â€œEnergia Immessa in Reteâ€
  unit_of_measurement: â€œWâ€
  device_class: power
  value_template: >
  {% set prod = states(â€˜sensor.produzione_totale_comuneâ€™)|float(0) %}
  {% set cons = states(â€˜sensor.consumo_totale_comuneâ€™)|float(0) %}
  {{ [prod - cons, 0]|max }}
  
  # Energia prelevata dalla rete
  
  energia_prelevata:
  friendly_name: â€œEnergia Prelevata dalla Reteâ€
  unit_of_measurement: â€œWâ€
  device_class: power
  value_template: >
  {% set prod = states(â€˜sensor.produzione_totale_comuneâ€™)|float(0) %}
  {% set cons = states(â€˜sensor.consumo_totale_comuneâ€™)|float(0) %}
  {{ [cons - prod, 0]|max }}

# Utility meter per calcoli orari/giornalieri/mensili

utility_meter:
produzione_oraria:
source: sensor.produzione_totale_comune
cycle: hourly

produzione_giornaliera:
source: sensor.produzione_totale_comune
cycle: daily

produzione_mensile:
source: sensor.produzione_totale_comune
cycle: monthly

consumo_orario:
source: sensor.consumo_totale_comune
cycle: hourly

consumo_giornaliero:
source: sensor.consumo_totale_comune
cycle: daily

consumo_mensile:
source: sensor.consumo_totale_comune
cycle: monthly

# Automazioni

automation:

# Invio dati orari a n8n

- id: invio_dati_orari_n8n
  alias: â€œInvio Dati Orari a n8nâ€
  trigger:
  - platform: time_pattern
    minutes: 0
    action:
  - service: rest_command.invia_dati_n8n
    data:
    sede: â€œcomuneâ€
    produzione: â€œ{{ states(â€˜sensor.produzione_orariaâ€™) }}â€
    consumo: â€œ{{ states(â€˜sensor.consumo_orarioâ€™) }}â€
    autoconsumo: â€œ{{ states(â€˜sensor.autoconsumo_istantaneoâ€™) }}â€
  
  # Pubblica su MQTT
  - service: mqtt.publish
    data:
    topic: â€œcer/magliano/comune/orarioâ€
    payload: >
    {
    â€œtimestampâ€: â€œ{{ now().isoformat() }}â€,
    â€œproduzione_kwhâ€: {{ states(â€˜sensor.produzione_orariaâ€™) }},
    â€œconsumo_kwhâ€: {{ states(â€˜sensor.consumo_orarioâ€™) }},
    â€œautoconsumo_kwhâ€: {{ states(â€˜sensor.autoconsumo_istantaneoâ€™) }},
    â€œimmessa_kwhâ€: {{ states(â€˜sensor.energia_immessaâ€™) }},
    â€œprelevata_kwhâ€: {{ states(â€˜sensor.energia_prelevataâ€™) }}
    }
    retain: true

# Alert anomalie produzione

- id: alert_produzione_bassa
  alias: â€œAlert Produzione Anomalaâ€
  trigger:
  - platform: numeric_state
    entity_id: sensor.produzione_totale_comune
    below: 1000
    for:
    hours: 2
    condition:
  - condition: sun
    after: sunrise
    after_offset: â€œ01:00:00â€
  - condition: sun
    before: sunset
    before_offset: â€œ-01:00:00â€
    action:
  - service: notify.telegram
    data:
    message: â€œâš ï¸ Produzione fotovoltaica anomala: {{ states(â€˜sensor.produzione_totale_comuneâ€™) }}Wâ€
  - service: mqtt.publish
    data:
    topic: â€œcer/magliano/alertsâ€
    payload: â€œproduzione_bassaâ€

# Ottimizzazione carichi (esempio illuminazione pubblica)

- id: gestione_illuminazione_intelligente
  alias: â€œGestione Intelligente Illuminazioneâ€
  trigger:
  - platform: numeric_state
    entity_id: sensor.energia_immessa
    above: 5000
    condition:
  - condition: time
    after: â€œ12:00:00â€
    before: â€œ16:00:00â€
    action:
  - service: notify.telegram
    data:
    message: â€œğŸ’¡ Surplus energetico: {{ states(â€˜sensor.energia_immessaâ€™) }}W disponibili per carichi differibiliâ€

# Dashboard Lovelace personalizzata

lovelace:
mode: yaml
resources:
- url: /local/mini-graph-card.js
type: module
dashboards:
cer-dashboard:
mode: yaml
title: CER Magliano
filename: cer_dashboard.yaml

# Notifiche

notify:

- name: telegram
  platform: telegram
  chat_id: !secret telegram_chat_id

# Input per configurazione manuale

input_number:
tariffa_incentivo_cer:
name: Tariffa Incentivo CER
min: 0
max: 0.2
step: 0.001
unit_of_measurement: â€˜â‚¬/kWhâ€™
initial: 0.119

percentuale_comune:
name: Percentuale Ripartizione Comune
min: 0
max: 100
step: 1
unit_of_measurement: â€˜%â€™
initial: 40

# Integrazione meteo per previsioni produzione

weather:

- platform: openweathermap
  api_key: !secret openweather_api_key
  latitude: 42.5944
  longitude: 11.2903
  mode: daily
